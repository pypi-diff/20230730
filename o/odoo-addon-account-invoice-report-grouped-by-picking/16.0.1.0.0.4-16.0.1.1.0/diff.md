# Comparing `tmp/odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4-py3-none-any.whl.zip` & `tmp/odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,25 +1,24 @@
-Zip file size: 32111 bytes, number of entries: 23
--rw-r--r--  2.0 unx     4050 b- defN 23-Feb-10 02:52 odoo/addons/account_invoice_report_grouped_by_picking/README.rst
--rw-r--r--  2.0 unx       21 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/__init__.py
--rw-r--r--  2.0 unx      730 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py
--rw-r--r--  2.0 unx     1429 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/i18n/account_invoice_report_grouped_by_picking.pot
--rw-r--r--  2.0 unx     1933 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/i18n/de.po
--rw-r--r--  2.0 unx     1808 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/i18n/es.po
--rw-r--r--  2.0 unx     1820 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/i18n/fr_FR.po
--rw-r--r--  2.0 unx     1667 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/i18n/pt.po
--rw-r--r--  2.0 unx       27 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/models/__init__.py
--rw-r--r--  2.0 unx     4312 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py
--rw-r--r--  2.0 unx      229 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx      317 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx      302 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/readme/ROADMAP.rst
--rw-r--r--  2.0 unx      337 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/readme/USAGE.rst
--rw-r--r--  2.0 unx     9455 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/static/description/icon.png
--rw-r--r--  2.0 unx    13735 b- defN 23-Feb-10 02:52 odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html
--rw-r--r--  2.0 unx       49 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/tests/__init__.py
--rw-r--r--  2.0 unx    12249 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/tests/test_account_invoice_group_picking.py
--rw-r--r--  2.0 unx     6441 b- defN 23-Feb-10 02:51 odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml
--rw-r--r--  2.0 unx     4715 b- defN 23-Feb-10 02:52 odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Feb-10 02:52 odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 23-Feb-10 02:52 odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     2993 b- defN 23-Feb-10 02:52 odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/RECORD
-23 files, 68716 bytes uncompressed, 26841 bytes compressed:  60.9%
+Zip file size: 31393 bytes, number of entries: 22
+-rw-r--r--  2.0 unx     3700 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/README.rst
+-rw-r--r--  2.0 unx       21 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/__init__.py
+-rw-r--r--  2.0 unx      730 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py
+-rw-r--r--  2.0 unx     1429 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/i18n/account_invoice_report_grouped_by_picking.pot
+-rw-r--r--  2.0 unx     1933 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/i18n/de.po
+-rw-r--r--  2.0 unx     1808 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/i18n/es.po
+-rw-r--r--  2.0 unx     1820 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/i18n/fr_FR.po
+-rw-r--r--  2.0 unx     1667 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/i18n/pt.po
+-rw-r--r--  2.0 unx       27 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/models/__init__.py
+-rw-r--r--  2.0 unx     5935 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py
+-rw-r--r--  2.0 unx      229 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      317 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx      337 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/readme/USAGE.rst
+-rw-r--r--  2.0 unx     9455 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/static/description/icon.png
+-rw-r--r--  2.0 unx    13165 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html
+-rw-r--r--  2.0 unx       49 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/tests/__init__.py
+-rw-r--r--  2.0 unx    12249 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/tests/test_account_invoice_group_picking.py
+-rw-r--r--  2.0 unx     5769 b- defN 23-Jun-08 01:00 odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml
+-rw-r--r--  2.0 unx     4363 b- defN 23-Jun-08 01:00 odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jun-08 01:00 odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Jun-08 01:00 odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     2857 b- defN 23-Jun-08 01:00 odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/RECORD
+22 files, 67957 bytes uncompressed, 26359 bytes compressed:  61.2%
```

## zipnote {}

```diff
@@ -30,17 +30,14 @@
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/readme/CONTRIBUTORS.rst
 Comment: 
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/readme/DESCRIPTION.rst
 Comment: 
 
-Filename: odoo/addons/account_invoice_report_grouped_by_picking/readme/ROADMAP.rst
-Comment: 
-
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/readme/USAGE.rst
 Comment: 
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/static/description/icon.png
 Comment: 
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html
@@ -51,20 +48,20 @@
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/tests/test_account_invoice_group_picking.py
 Comment: 
 
 Filename: odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml
 Comment: 
 
-Filename: odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/METADATA
+Filename: odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/METADATA
 Comment: 
 
-Filename: odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/WHEEL
+Filename: odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/WHEEL
 Comment: 
 
-Filename: odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/top_level.txt
+Filename: odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/RECORD
+Filename: odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/account_invoice_report_grouped_by_picking/README.rst

```diff
@@ -45,22 +45,14 @@
 #. Deliver pickings related to each sale order.
 #. Go to *Sales > To Invoice > Orders to Invoice* and invoice these sale
    orders.
 #. Open invoice newly created and print it.
 #. Invoice report will group invoice lines and show information about sales
    and pickings in every group.
 
-Known issues / Roadmap
-======================
-
-* As a result of the grouping by pickings, we don't support notes and descriptions.
-* Anyways, an invoice with no pickings should be printed as usual. The problem is
-  that in the current state of the report, a heavy refactoring is needed to be able to
-  fallback to the regular behavior in such case.
-
 Bug Tracker
 ===========
 
 Bugs are tracked on `GitHub Issues <https://github.com/OCA/account-invoice-reporting/issues>`_.
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
 `feedback <https://github.com/OCA/account-invoice-reporting/issues/new?body=module:%20account_invoice_report_grouped_by_picking%0Aversion:%2016.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**>`_.
```

## odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py

```diff
@@ -3,15 +3,15 @@
 # Copyright 2018-2019 Tecnativa - Pedro M. Baeza
 # Copyright 2021 Tecnativa - Jo√£o Marques
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
 
 {
     "name": "Account Invoice Grouped by Picking",
     "summary": "Print invoice lines grouped by picking",
-    "version": "16.0.1.0.0",
+    "version": "16.0.1.1.0",
     "category": "Accounting & Finance",
     "website": "https://github.com/OCA/account-invoice-reporting",
     "author": "Tecnativa, " "Odoo Community Association (OCA)",
     "license": "AGPL-3",
     "depends": ["stock_picking_invoice_link"],
     "data": ["views/report_invoice.xml"],
     "installable": True,
```

## odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py

```diff
@@ -1,31 +1,34 @@
 # Copyright 2017 Tecnativa - Carlos Dauden
 # Copyright 2018 Tecnativa - David Vidal
 # Copyright 2018-2019 Tecnativa - Pedro M. Baeza
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
-
+import datetime
 from collections import OrderedDict
 
 from odoo import api, models
 from odoo.tools import float_is_zero
 
 
 class AccountMove(models.Model):
     _inherit = "account.move"
 
     @api.model
     def _sort_grouped_lines(self, lines_dic):
         DTF = "%Y-%m-%d %H:%M:%S"
+        min_date = datetime.datetime.min
         return sorted(
             lines_dic,
             key=lambda x: (
                 x["picking"]
                 and (
-                    x["picking"].date and x["picking"].date.strftime(DTF),
-                    (x["picking"].date_done or x["picking"].date).strftime(DTF),
+                    (x["picking"].date or min_date).strftime(DTF),
+                    (x["picking"].date_done or x["picking"].date or min_date).strftime(
+                        DTF
+                    ),
                 )
                 or ("", "")
             ),
         )
 
     def _get_signed_quantity_done(self, invoice_line, move, sign):
         """Hook method. Usage example:
@@ -34,20 +37,31 @@
         qty = 0
         if move.location_id.usage == "customer":
             qty = -move.quantity_done * sign
         elif move.location_dest_id.usage == "customer":
             qty = move.quantity_done * sign
         return qty
 
+    def _process_section_note_lines_grouped(
+        self, previous_section, previous_note, lines_dic, pick_order=None
+    ):
+        key_section = (pick_order, previous_section) if pick_order else previous_section
+        if previous_section and key_section not in lines_dic:
+            lines_dic[key_section] = 0.0
+        key_note = (pick_order, previous_note) if pick_order else previous_note
+        if previous_note and key_note not in lines_dic:
+            lines_dic[key_note] = 0.0
+
     def lines_grouped_by_picking(self):
         """This prepares a data structure for printing the invoice report
         grouped by pickings."""
         self.ensure_one()
         picking_dict = OrderedDict()
         lines_dict = OrderedDict()
+        picking_obj = self.env["stock.picking"]
         # Not change sign if the credit note has been created from reverse move option
         # and it has the same pickings related than the reversed invoice instead of sale
         # order invoicing process after picking reverse transfer
         sign = (
             -1.0
             if self.move_type == "out_refund"
             and (
@@ -55,52 +69,73 @@
                 or self.reversed_entry_id.picking_ids != self.picking_ids
             )
             else 1.0
         )
         # Let's get first a correspondance between pickings and sales order
         so_dict = {x.sale_id: x for x in self.picking_ids if x.sale_id}
         # Now group by picking by direct link or via same SO as picking's one
-        for line in self.invoice_line_ids:
-            if line.display_type != "product":
+        previous_section = previous_note = False
+        for line in self.invoice_line_ids.sorted(
+            lambda ln: (-ln.sequence, ln.date, ln.move_name, -ln.id), reverse=True
+        ):
+            if line.display_type == "line_section":
+                previous_section = line
+                continue
+            if line.display_type == "line_note":
+                previous_note = line
                 continue
             has_returned_qty = False
             remaining_qty = line.quantity
             for move in line.move_line_ids:
                 key = (move.picking_id, line)
+                self._process_section_note_lines_grouped(
+                    previous_section, previous_note, picking_dict, move.picking_id
+                )
                 picking_dict.setdefault(key, 0)
+                if move.location_id.usage == "customer":
+                    has_returned_qty = True
                 qty = self._get_signed_quantity_done(line, move, sign)
                 picking_dict[key] += qty
                 remaining_qty -= qty
             if not line.move_line_ids and line.sale_line_ids:
                 for so_line in line.sale_line_ids:
                     if so_dict.get(so_line.order_id):
                         key = (so_dict[so_line.order_id], line)
+                        self._process_section_note_lines_grouped(
+                            previous_section,
+                            previous_note,
+                            picking_dict,
+                            so_dict[so_line.order_id],
+                        )
                         picking_dict.setdefault(key, 0)
                         qty = so_line.product_uom_qty
                         picking_dict[key] += qty
                         remaining_qty -= qty
             elif not line.move_line_ids and not line.sale_line_ids:
-                key = (self.env["stock.picking"], line)
+                key = (picking_obj, line)
                 picking_dict.setdefault(key, 0)
                 qty = line.quantity
                 picking_dict[key] += qty
                 remaining_qty -= qty
             # To avoid to print duplicate lines because the invoice is a refund
             # without returned goods to refund.
             if self.move_type == "out_refund" and not has_returned_qty:
                 remaining_qty = 0.0
                 for key in picking_dict:
                     picking_dict[key] = abs(picking_dict[key])
             if not float_is_zero(
                 remaining_qty,
                 precision_rounding=line.product_id.uom_id.rounding or 0.01,
             ):
+                self._process_section_note_lines_grouped(
+                    previous_section, previous_note, lines_dict
+                )
                 lines_dict[line] = remaining_qty
         no_picking = [
-            {"picking": False, "line": key, "quantity": value}
+            {"picking": picking_obj, "line": key, "quantity": value}
             for key, value in lines_dict.items()
         ]
         with_picking = [
             {"picking": key[0], "line": key[1], "quantity": value}
             for key, value in picking_dict.items()
         ]
         return no_picking + self._sort_grouped_lines(with_picking)
```

## odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html

### odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html

```diff
@@ -392,30 +392,27 @@
       </p>
       <div class="contents local topic" id="contents">
         <ul class="simple">
           <li>
             <a class="reference internal" href="#usage" id="id1">Usage</a>
           </li>
           <li>
-            <a class="reference internal" href="#known-issues-roadmap" id="id2">Known issues / Roadmap</a>
+            <a class="reference internal" href="#bug-tracker" id="id2">Bug Tracker</a>
           </li>
           <li>
-            <a class="reference internal" href="#bug-tracker" id="id3">Bug Tracker</a>
-          </li>
-          <li>
-            <a class="reference internal" href="#credits" id="id4">Credits</a>
+            <a class="reference internal" href="#credits" id="id3">Credits</a>
             <ul>
               <li>
-                <a class="reference internal" href="#authors" id="id5">Authors</a>
+                <a class="reference internal" href="#authors" id="id4">Authors</a>
               </li>
               <li>
-                <a class="reference internal" href="#contributors" id="id6">Contributors</a>
+                <a class="reference internal" href="#contributors" id="id5">Contributors</a>
               </li>
               <li>
-                <a class="reference internal" href="#maintainers" id="id7">Maintainers</a>
+                <a class="reference internal" href="#maintainers" id="id6">Maintainers</a>
               </li>
             </ul>
           </li>
         </ul>
       </div>
       <div class="section" id="usage">
         <h1>
@@ -431,55 +428,44 @@
 orders.
           </li>
           <li>Open invoice newly created and print it.</li>
           <li>Invoice report will group invoice lines and show information about sales
 and pickings in every group.</li>
         </ol>
       </div>
-      <div class="section" id="known-issues-roadmap">
-        <h1>
-          <a class="toc-backref" href="#id2">Known issues / Roadmap</a>
-        </h1>
-        <ul class="simple">
-          <li>As a result of the grouping by pickings, we don‚Äôt support notes and descriptions.</li>
-          <li>Anyways, an invoice with no pickings should be printed as usual. The problem is
-that in the current state of the report, a heavy refactoring is needed to be able to
-fallback to the regular behavior in such case.</li>
-        </ul>
-      </div>
       <div class="section" id="bug-tracker">
         <h1>
-          <a class="toc-backref" href="#id3">Bug Tracker</a>
+          <a class="toc-backref" href="#id2">Bug Tracker</a>
         </h1>
         <p>
           Bugs are tracked on
           <a class="reference external" href="https://github.com/OCA/account-invoice-reporting/issues">GitHub Issues</a>
           .
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
           <a class="reference external" href="https://github.com/OCA/account-invoice-reporting/issues/new?body=module:%20account_invoice_report_grouped_by_picking%0Aversion:%2016.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**">feedback</a>
           .
         </p>
         <p>Do not contact contributors directly about support or help with technical issues.</p>
       </div>
       <div class="section" id="credits">
         <h1>
-          <a class="toc-backref" href="#id4">Credits</a>
+          <a class="toc-backref" href="#id3">Credits</a>
         </h1>
         <div class="section" id="authors">
           <h2>
-            <a class="toc-backref" href="#id5">Authors</a>
+            <a class="toc-backref" href="#id4">Authors</a>
           </h2>
           <ul class="simple">
             <li>Tecnativa</li>
           </ul>
         </div>
         <div class="section" id="contributors">
           <h2>
-            <a class="toc-backref" href="#id6">Contributors</a>
+            <a class="toc-backref" href="#id5">Contributors</a>
           </h2>
           <ul class="simple">
             <li>
               <a class="reference external" href="https://www.tecnativa.com">Tecnativa</a>
               :
               <ul>
                 <li>Carlos Dauden</li>
@@ -501,15 +487,15 @@
                 </li>
               </ul>
             </li>
           </ul>
         </div>
         <div class="section" id="maintainers">
           <h2>
-            <a class="toc-backref" href="#id7">Maintainers</a>
+            <a class="toc-backref" href="#id6">Maintainers</a>
           </h2>
           <p>This module is maintained by the OCA.</p>
           <a class="reference external image-reference" href="https://odoo-community.org">
             <img alt="Odoo Community Association" src="https://odoo-community.org/logo.png"/>
           </a>
           <p>OCA, or the Odoo Community Association, is a nonprofit organization whose
 mission is to support the collaborative development of Odoo features and
```

## odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml

### odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml

```diff
@@ -1,29 +1,34 @@
 <?xml version="1.0" encoding="utf-8"?>
 <odoo>
   <template id="report_invoice_document" inherit_id="account.report_invoice_document">
+    <xpath expr="//t[contains(@t-set, 'o')]" position="after">
+      <t t-set="lines_grouped" t-value="o.lines_grouped_by_picking()"/>
+    </xpath>
     <xpath expr="//t[contains(@t-foreach, 'lines')]/t[3]" position="attributes">
       <attribute name="t-if">False</attribute>
     </xpath>
     <xpath expr="//tbody[hasclass('invoice_tbody')]" position="inside">
       <t t-set="subtotal" t-value="0.0"/>
-      <t t-set="lines_grouped" t-value="o.lines_grouped_by_picking()"/>
     </xpath>
     <xpath expr="//t[contains(@t-foreach, 'lines')]" position="attributes">
-      <attribute name="t-foreach">o.lines_grouped_by_picking()</attribute>
+      <attribute name="t-foreach">lines_grouped</attribute>
       <attribute name="t-as">lines_group</attribute>
     </xpath>
     <!-- Appends before 'current_subtotal' compute -->
     <xpath expr="//t[@groups='account.group_show_line_subtotals_tax_excluded']" position="before">
       <t t-set="l" t-value="lines_group['line']"/>
       <t t-set="line" t-value="lines_group['line']"/>
       <t t-set="picking" t-value="lines_group['picking']"/>
-      <t t-set="lines_grouped" t-value="o.lines_grouped_by_picking()"/>
       <t t-set="next_picking" t-value="[lines_grouped[i + 1]['picking'] for i, x in enumerate(lines_grouped) if x == lines_group and i &lt; len(lines_grouped) - 1] or [False]"/>
+      <!-- Avoid to show original subtotal -->
+      <t t-set="line_last" t-value="False"/>
+      <t t-set="line_index" t-value="0"/>
       <t t-if="picking != last_picking">
+        <t t-set="last_picking" t-value="picking"/>
         <tr t-if="picking">
           <td colspan="10">
             <strong>
               <span>Order:</span>
               <span t-field="picking.sale_id.name"/>
               <t t-if="picking.sale_id.client_order_ref">
                 <span t-translation="off">(</span>
@@ -47,51 +52,40 @@
     </xpath>
     <xpath expr="//td/span[@t-field='line.quantity']" position="attributes">
       <attribute name="t-esc">lines_group['quantity']</attribute>
       <attribute name="t-field"/>
       <attribute name="t-options">{'widget': 'float', 'decimal_precision': 'Product Unit of Measure'}</attribute>
     </xpath>
     <xpath expr="//td/span[@t-field='line.price_subtotal']" position="before">
-      <t t-if="lines_group['quantity'] != l.quantity" id="picking_subtotal" groups="!account.group_show_line_subtotals_tax_included">
+      <t t-set="line_subtotal" t-value="l.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
+      <t t-set="line_subtotal" t-value="l.price_total" groups="account.group_show_line_subtotals_tax_included"/>
+      <t t-if="lines_group['quantity'] != l.quantity" id="picking_subtotal">
         <!-- Compute subtotal for that picking with discounts -->
-        <t t-set="line_picking_subtotal" t-value="l.quantity and lines_group['quantity'] * (l.price_subtotal / l.quantity) or 0.0"/>
+        <t t-set="line_picking_subtotal" t-value="l.quantity and lines_group['quantity'] * (line_subtotal / l.quantity) or 0.0"/>
         <t t-set="subtotal" t-value="(subtotal or 0.0) + line_picking_subtotal"/>
         <span t-esc="line_picking_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
       </t>
       <t t-else="">
-        <t t-set="subtotal" t-value="(subtotal or 0.0) + l.price_subtotal"/>
+        <t t-set="subtotal" t-value="(subtotal or 0.0) + line_subtotal"/>
       </t>
     </xpath>
     <xpath expr="//td/span[@t-field='line.price_subtotal']" position="attributes">
       <attribute name="t-if">lines_group['quantity'] == l.quantity</attribute>
     </xpath>
     <xpath expr="//td/span[@t-field='line.price_total']" position="attributes">
       <attribute name="t-if">lines_group['quantity'] == l.quantity</attribute>
     </xpath>
     <!-- Append subtotal row after invoice line row-->
-    <xpath expr="//t[@t-foreach='o.lines_grouped_by_picking()']//td[hasclass('o_price_total')]" position="after">
+    <xpath expr="//t[@t-foreach='lines_grouped']//td[hasclass('o_price_total')]" position="after">
       <tr t-if="picking != next_picking[0]">
         <td colspan="10" class="text-right">
           <strong>Subtotal:</strong>
           <strong t-esc="subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
         </td>
         <t t-set="subtotal" t-value="0.0"/>
       </tr>
-      <t t-set="last_picking" t-value="picking"/>
-    </xpath>
-    <!-- Replicate logic if B2C prices-->
-    <xpath expr="//td/span[@t-field='line.price_total']" position="before">
-      <t t-if="lines_group['quantity'] != l.quantity" groups="account.group_show_line_subtotals_tax_included">
-        <!-- Compute subtotal for that picking with discounts -->
-        <t t-set="line_picking_subtotal" t-value="l.quantity and lines_group['quantity'] * (l.price_total / l.quantity) or 0.0"/>
-        <t t-set="subtotal" t-value="(subtotal or 0.0) + line_picking_subtotal"/>
-        <span t-esc="line_picking_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
-      </t>
-      <t t-else="">
-        <t t-set="subtotal" t-value="(subtotal or 0.0) + l.price_total"/>
-      </t>
     </xpath>
     <xpath expr="//td/span[@t-field='line.price_total']" position="attributes">
       <attribute name="t-if">lines_group['quantity'] == l.quantity</attribute>
     </xpath>
   </template>
 </odoo>
```

## Comparing `odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/METADATA` & `odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/METADATA`

 * *Files 5% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo-addon-account-invoice-report-grouped-by-picking
-Version: 16.0.1.0.0.4
+Version: 16.0.1.1.0
 Summary: Print invoice lines grouped by picking
 Home-page: https://github.com/OCA/account-invoice-reporting
 Author: Tecnativa, Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
@@ -62,22 +62,14 @@
 #. Deliver pickings related to each sale order.
 #. Go to *Sales > To Invoice > Orders to Invoice* and invoice these sale
    orders.
 #. Open invoice newly created and print it.
 #. Invoice report will group invoice lines and show information about sales
    and pickings in every group.
 
-Known issues / Roadmap
-======================
-
-* As a result of the grouping by pickings, we don't support notes and descriptions.
-* Anyways, an invoice with no pickings should be printed as usual. The problem is
-  that in the current state of the report, a heavy refactoring is needed to be able to
-  fallback to the regular behavior in such case.
-
 Bug Tracker
 ===========
 
 Bugs are tracked on `GitHub Issues <https://github.com/OCA/account-invoice-reporting/issues>`_.
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
 `feedback <https://github.com/OCA/account-invoice-reporting/issues/new?body=module:%20account_invoice_report_grouped_by_picking%0Aversion:%2016.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**>`_.
```

## Comparing `odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/RECORD` & `odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/RECORD`

 * *Files 6% similar despite different names*

```diff
@@ -1,23 +1,22 @@
-odoo/addons/account_invoice_report_grouped_by_picking/README.rst,sha256=ymvfrh8ayal62Wz_0PiDsyiEc3j2DybOAGyyyJZNVhQ,4050
+odoo/addons/account_invoice_report_grouped_by_picking/README.rst,sha256=sld4xvOfRlGOixohgMOexb7sYdtXgPr6nASuESShGPs,3700
 odoo/addons/account_invoice_report_grouped_by_picking/__init__.py,sha256=X9EJGOE2GtZbS0G82PtSXmWSZ_R8jEM0rlJTDliQjp4,21
-odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py,sha256=YUok6S8XpORyvHs2j63fyrK_e3vLEFjYtsajd658qyo,730
+odoo/addons/account_invoice_report_grouped_by_picking/__manifest__.py,sha256=Dg5nAtOyERxYfchVyTKg1HXLwHqb6FcBWurMKr2xDGo,730
 odoo/addons/account_invoice_report_grouped_by_picking/i18n/account_invoice_report_grouped_by_picking.pot,sha256=o7s7pjQl1eg8a1iE-LMyMnWlfzOsi372I1cmuaRYj-E,1429
 odoo/addons/account_invoice_report_grouped_by_picking/i18n/de.po,sha256=-FxNKSxeQ8Ok-j-WBXBS6t3n6O1r8Dm_p_zFHimZ1Sw,1933
 odoo/addons/account_invoice_report_grouped_by_picking/i18n/es.po,sha256=QGE1POSfo31eWzS80aD4ubIo8rGAQOBLlNPaYrCg-fE,1808
 odoo/addons/account_invoice_report_grouped_by_picking/i18n/fr_FR.po,sha256=2RupN7ZaBg2MZqTVfIHHL3OVinQ_QIAi0R7tGemfcNQ,1820
 odoo/addons/account_invoice_report_grouped_by_picking/i18n/pt.po,sha256=3Jr08cGQ37o2vpOIeGHohSnqU_SwKfBuT34l0RX2cD0,1667
 odoo/addons/account_invoice_report_grouped_by_picking/models/__init__.py,sha256=9829nnQdRNsJmZEDfsGtCQQqM2W0JuYarPptYP2zJzU,27
-odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py,sha256=w7yH7ySySh0X1cv_vz0wmUdvXzEX7nZyeqaBrnS41OM,4312
+odoo/addons/account_invoice_report_grouped_by_picking/models/account_move.py,sha256=Y7JYWa_WJriTfb3ikAa5mSJ3FM2ssZOz1ORMtRzWGG0,5935
 odoo/addons/account_invoice_report_grouped_by_picking/readme/CONTRIBUTORS.rst,sha256=JDa1Aa3geSpnW2wulMhpVDhQ_v-zD17NKErqnrFvAfI,229
 odoo/addons/account_invoice_report_grouped_by_picking/readme/DESCRIPTION.rst,sha256=82ARWU3EdaEvvajAt1n6cV9n3Lke6HhMP3nep_Xx7Z0,317
-odoo/addons/account_invoice_report_grouped_by_picking/readme/ROADMAP.rst,sha256=MheG5RgkEXF5mSoPC3qSxQXnPeKbzDqw1mBBkKRzf-8,302
 odoo/addons/account_invoice_report_grouped_by_picking/readme/USAGE.rst,sha256=mfnqkZNl94BNS2Tq7owYLw7LjVzYiprEPAJLsKcoH3U,337
 odoo/addons/account_invoice_report_grouped_by_picking/static/description/icon.png,sha256=6xBPJauaFOF0KDHfHgQopSc28kKvxMaeoQFQWZtfZDo,9455
-odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html,sha256=Q9j-kULbgbewBEMpprAIC17ME97KS7Y1XFPq358NHgM,13735
+odoo/addons/account_invoice_report_grouped_by_picking/static/description/index.html,sha256=ELWzsgVuouaGrd05gPrcAlFj_3NrxEYFyT4NVrlH6Z8,13165
 odoo/addons/account_invoice_report_grouped_by_picking/tests/__init__.py,sha256=NNnN1-zIGuye0p_0vys1VmOZrygIGrrve7EVeFdEofY,49
 odoo/addons/account_invoice_report_grouped_by_picking/tests/test_account_invoice_group_picking.py,sha256=c9U_N4VrBJvm_4TcHdiQ5p6s4wr8QZkaTTaSOn-NmWU,12249
-odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml,sha256=o78ooes0oBHHGrgQUOCtXtDfY5LXlyJWtmTKWy6bNmY,6441
-odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/METADATA,sha256=BLMDAdWNjF11qIeX6YO9WHMwiFC8s4FsOM7ioV5L0Xc,4715
-odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
-odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.0.0.4.dist-info/RECORD,,
+odoo/addons/account_invoice_report_grouped_by_picking/views/report_invoice.xml,sha256=3_xpS_PNUf6Ob2wxJzOowxmIoR1NywafkFWDZ6qEhOo,5769
+odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/METADATA,sha256=MQI8CeJRfA2OIJ8iVvxIrpGQxzWjX_qHrihzWY1wVn8,4363
+odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
+odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo_addon_account_invoice_report_grouped_by_picking-16.0.1.1.0.dist-info/RECORD,,
```


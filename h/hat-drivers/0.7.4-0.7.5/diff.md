# Comparing `tmp/hat_drivers-0.7.4-cp310.cp311-abi3-win_amd64.whl.zip` & `tmp/hat_drivers-0.7.5-cp310.cp311-abi3-win_amd64.whl.zip`

## zipinfo {}

```diff
@@ -1,23 +1,23 @@
-Zip file size: 275451 bytes, number of entries: 110
+Zip file size: 275806 bytes, number of entries: 110
 -rw-r--r--  2.0 unx       28 b- defN 21-May-03 22:33 hat/drivers/__init__.py
 -rw-r--r--  2.0 unx     2691 b- defN 23-Jul-08 10:50 hat/drivers/ssdp.py
 -rw-r--r--  2.0 unx    12953 b- defN 23-Jul-08 10:50 hat/drivers/tcp.py
 -rw-r--r--  2.0 unx     4582 b- defN 23-Jul-08 10:50 hat/drivers/tpkt.py
 -rw-r--r--  2.0 unx     3139 b- defN 23-Jul-08 10:50 hat/drivers/udp.py
 -rw-r--r--  2.0 unx    18002 b- defN 23-Jul-08 10:50 hat/drivers/acse/__init__.py
--rw-r--r--  2.0 unx     8498 b- defN 23-Jul-18 23:54 hat/drivers/acse/asn1_repo.json
+-rw-r--r--  2.0 unx     8498 b- defN 23-Jul-29 23:25 hat/drivers/acse/asn1_repo.json
 -rw-r--r--  2.0 unx     1024 b- defN 22-Nov-01 19:30 hat/drivers/cdt/__init__.py
 -rw-r--r--  2.0 unx      286 b- defN 22-Oct-30 23:00 hat/drivers/cdt/browser.py
 -rw-r--r--  2.0 unx     3466 b- defN 23-Jul-08 10:50 hat/drivers/cdt/connection.py
 -rw-r--r--  2.0 unx      596 b- defN 22-Nov-01 19:29 hat/drivers/cdt/page.py
 -rw-r--r--  2.0 unx     1268 b- defN 23-Jul-08 10:50 hat/drivers/cdt/runtime.py
 -rw-r--r--  2.0 unx     2807 b- defN 23-Jul-08 10:50 hat/drivers/cdt/target.py
 -rw-r--r--  2.0 unx    17263 b- defN 23-Jul-08 10:50 hat/drivers/copp/__init__.py
--rw-r--r--  2.0 unx    12628 b- defN 23-Jul-18 23:54 hat/drivers/copp/asn1_repo.json
+-rw-r--r--  2.0 unx    12628 b- defN 23-Jul-29 23:25 hat/drivers/copp/asn1_repo.json
 -rw-r--r--  2.0 unx      582 b- defN 23-Jul-08 10:50 hat/drivers/cosp/__init__.py
 -rw-r--r--  2.0 unx      670 b- defN 23-Jul-08 10:50 hat/drivers/cosp/common.py
 -rw-r--r--  2.0 unx    13338 b- defN 23-Jul-08 10:50 hat/drivers/cosp/connection.py
 -rw-r--r--  2.0 unx     3895 b- defN 23-Jul-08 10:50 hat/drivers/cosp/encoder.py
 -rw-r--r--  2.0 unx      506 b- defN 23-Jul-08 10:50 hat/drivers/cotp/__init__.py
 -rw-r--r--  2.0 unx     1747 b- defN 23-Jul-08 10:50 hat/drivers/cotp/common.py
 -rw-r--r--  2.0 unx    10851 b- defN 23-Jul-08 10:50 hat/drivers/cotp/connection.py
@@ -55,58 +55,58 @@
 -rw-r--r--  2.0 unx     9948 b- defN 23-Jul-13 20:31 hat/drivers/iec60870/encodings/iec104/encoder.py
 -rw-r--r--  2.0 unx     2227 b- defN 23-Jul-13 20:29 hat/drivers/iec60870/encodings/security/__init__.py
 -rw-r--r--  2.0 unx     7298 b- defN 23-Jul-13 20:32 hat/drivers/iec60870/encodings/security/common.py
 -rw-r--r--  2.0 unx    25146 b- defN 23-Jul-13 20:33 hat/drivers/iec60870/encodings/security/encoder.py
 -rw-r--r--  2.0 unx      146 b- defN 23-Jul-18 22:35 hat/drivers/iec60870/link/__init__.py
 -rw-r--r--  2.0 unx     1309 b- defN 23-Jul-18 22:35 hat/drivers/iec60870/link/common.py
 -rw-r--r--  2.0 unx     4838 b- defN 23-Jul-08 10:50 hat/drivers/iec60870/link/encoder.py
--rw-r--r--  2.0 unx     1999 b- defN 23-Jul-18 21:30 hat/drivers/iec60870/link/endpoint.py
+-rw-r--r--  2.0 unx     2084 b- defN 23-Jul-29 23:00 hat/drivers/iec60870/link/endpoint.py
 -rw-r--r--  2.0 unx       90 b- defN 22-Mar-03 17:24 hat/drivers/iec60870/link/balanced/__init__.py
 -rw-r--r--  2.0 unx     1117 b- defN 23-Jul-18 20:37 hat/drivers/iec60870/link/balanced/connection.py
 -rw-r--r--  2.0 unx      771 b- defN 23-Jul-18 22:37 hat/drivers/iec60870/link/unbalanced/__init__.py
--rw-r--r--  2.0 unx    11724 b- defN 23-Jul-18 23:18 hat/drivers/iec60870/link/unbalanced/master.py
+-rw-r--r--  2.0 unx    11769 b- defN 23-Jul-29 23:04 hat/drivers/iec60870/link/unbalanced/master.py
 -rw-r--r--  2.0 unx     8459 b- defN 23-Jul-18 23:22 hat/drivers/iec60870/link/unbalanced/slave.py
 -rw-r--r--  2.0 unx     4404 b- defN 23-Jul-08 10:50 hat/drivers/mms/__init__.py
--rw-r--r--  2.0 unx   186717 b- defN 23-Jul-18 23:54 hat/drivers/mms/asn1_repo.json
+-rw-r--r--  2.0 unx   186717 b- defN 23-Jul-29 23:25 hat/drivers/mms/asn1_repo.json
 -rw-r--r--  2.0 unx     8238 b- defN 23-Jul-08 10:50 hat/drivers/mms/common.py
 -rw-r--r--  2.0 unx    13117 b- defN 23-Jul-08 10:50 hat/drivers/mms/connection.py
 -rw-r--r--  2.0 unx    26924 b- defN 23-Jul-08 10:50 hat/drivers/mms/encoder.py
 -rw-r--r--  2.0 unx     1112 b- defN 23-Jan-07 03:37 hat/drivers/modbus/__init__.py
 -rw-r--r--  2.0 unx      532 b- defN 21-May-19 00:33 hat/drivers/modbus/common.py
--rw-r--r--  2.0 unx    13153 b- defN 23-Jul-08 10:50 hat/drivers/modbus/master.py
+-rw-r--r--  2.0 unx    13194 b- defN 23-Jul-29 23:19 hat/drivers/modbus/master.py
 -rw-r--r--  2.0 unx    16491 b- defN 23-Jul-08 10:50 hat/drivers/modbus/slave.py
 -rw-r--r--  2.0 unx     3526 b- defN 23-Jan-06 17:57 hat/drivers/modbus/transport/__init__.py
--rwxr-xr-x  2.0 unx   108045 b- defN 23-Jul-18 23:54 hat/drivers/modbus/transport/_encoder.abi3.pyd
+-rwxr-xr-x  2.0 unx   108045 b- defN 23-Jul-29 23:25 hat/drivers/modbus/transport/_encoder.abi3.pyd
 -rw-r--r--  2.0 unx     4552 b- defN 23-Jul-08 10:50 hat/drivers/modbus/transport/common.py
--rw-r--r--  2.0 unx     4709 b- defN 23-Jul-08 10:50 hat/drivers/modbus/transport/connection.py
+-rw-r--r--  2.0 unx     4975 b- defN 23-Jul-29 22:55 hat/drivers/modbus/transport/connection.py
 -rw-r--r--  2.0 unx    19933 b- defN 23-Jul-08 10:50 hat/drivers/modbus/transport/encoder.py
 -rw-r--r--  2.0 unx      823 b- defN 22-Sep-12 23:42 hat/drivers/pnetgateway/__init__.py
 -rw-r--r--  2.0 unx     6296 b- defN 23-Jul-08 10:50 hat/drivers/pnetgateway/client.py
 -rw-r--r--  2.0 unx     1142 b- defN 23-Jul-08 10:50 hat/drivers/pnetgateway/common.py
 -rw-r--r--  2.0 unx     1881 b- defN 23-Jul-08 10:50 hat/drivers/pnetgateway/encoder.py
 -rw-r--r--  2.0 unx      803 b- defN 23-Jul-08 10:50 hat/drivers/pnetgateway/transport.py
 -rw-r--r--  2.0 unx     1965 b- defN 23-Jul-08 10:50 hat/drivers/serial/__init__.py
--rwxr-xr-x  2.0 unx   120682 b- defN 23-Jul-18 23:54 hat/drivers/serial/_native_serial.abi3.pyd
--rw-r--r--  2.0 unx     1103 b- defN 23-Jul-08 10:50 hat/drivers/serial/common.py
--rw-r--r--  2.0 unx     5794 b- defN 23-Apr-19 17:27 hat/drivers/serial/native_serial.py
--rw-r--r--  2.0 unx     4681 b- defN 23-Apr-10 22:50 hat/drivers/serial/py_serial.py
+-rwxr-xr-x  2.0 unx   120822 b- defN 23-Jul-29 23:25 hat/drivers/serial/_native_serial.abi3.pyd
+-rw-r--r--  2.0 unx     1244 b- defN 23-Jul-29 21:16 hat/drivers/serial/common.py
+-rw-r--r--  2.0 unx     6403 b- defN 23-Jul-29 22:32 hat/drivers/serial/native_serial.py
+-rw-r--r--  2.0 unx     5067 b- defN 23-Jul-29 21:16 hat/drivers/serial/py_serial.py
 -rw-r--r--  2.0 unx     1879 b- defN 23-Jul-08 10:50 hat/drivers/snmp/__init__.py
 -rw-r--r--  2.0 unx     6185 b- defN 23-Jul-08 10:50 hat/drivers/snmp/agent.py
 -rw-r--r--  2.0 unx     4871 b- defN 23-Jul-08 10:50 hat/drivers/snmp/common.py
 -rw-r--r--  2.0 unx     7546 b- defN 23-Jul-08 10:50 hat/drivers/snmp/manager.py
 -rw-r--r--  2.0 unx    12554 b- defN 23-Jul-08 10:50 hat/drivers/snmp/trap.py
 -rw-r--r--  2.0 unx     2598 b- defN 23-Jul-08 10:50 hat/drivers/snmp/encoder/__init__.py
--rw-r--r--  2.0 unx     9211 b- defN 23-Jul-18 23:54 hat/drivers/snmp/encoder/asn1_repo.json
+-rw-r--r--  2.0 unx     9211 b- defN 23-Jul-29 23:25 hat/drivers/snmp/encoder/asn1_repo.json
 -rw-r--r--  2.0 unx     6241 b- defN 23-Jul-08 10:50 hat/drivers/snmp/encoder/v1.py
 -rw-r--r--  2.0 unx     7935 b- defN 23-Jul-08 10:50 hat/drivers/snmp/encoder/v2c.py
 -rw-r--r--  2.0 unx     1943 b- defN 22-May-10 19:12 hat/drivers/snmp/encoder/v3.py
 -rw-r--r--  2.0 unx     2082 b- defN 23-Jul-08 10:50 hat/drivers/ssl/__init__.py
--rwxr-xr-x  2.0 unx   107412 b- defN 23-Jul-18 23:54 hat/drivers/ssl/_ssl.abi3.pyd
+-rwxr-xr-x  2.0 unx   107412 b- defN 23-Jul-29 23:25 hat/drivers/ssl/_ssl.abi3.pyd
 -rw-r--r--  2.0 unx       34 b- defN 21-May-03 22:27 hat/drivers/upnp/__init__.py
 -rw-r--r--  2.0 unx     3132 b- defN 23-Jul-08 10:50 hat/drivers/upnp/description.py
--rw-r--r--  2.0 unx    11358 b- defN 23-Jul-18 23:54 hat_drivers-0.7.4.dist-info/LICENSE
--rw-r--r--  2.0 unx     2484 b- defN 23-Jul-18 23:54 hat_drivers-0.7.4.dist-info/METADATA
--rw-r--r--  2.0 unx      127 b- defN 23-Jul-18 23:54 hat_drivers-0.7.4.dist-info/WHEEL
--rw-r--r--  2.0 unx        4 b- defN 23-Jul-18 23:54 hat_drivers-0.7.4.dist-info/top_level.txt
--rw-r--r--  2.0 unx        1 b- defN 23-Jul-18 23:54 hat_drivers-0.7.4.dist-info/zip-safe
--rw-rw-r--  2.0 unx     9927 b- defN 23-Jul-18 23:54 hat_drivers-0.7.4.dist-info/RECORD
-110 files, 1259494 bytes uncompressed, 259653 bytes compressed:  79.4%
+-rw-r--r--  2.0 unx    11358 b- defN 23-Jul-29 23:25 hat_drivers-0.7.5.dist-info/LICENSE
+-rw-r--r--  2.0 unx     2484 b- defN 23-Jul-29 23:25 hat_drivers-0.7.5.dist-info/METADATA
+-rw-r--r--  2.0 unx      127 b- defN 23-Jul-29 23:25 hat_drivers-0.7.5.dist-info/WHEEL
+-rw-r--r--  2.0 unx        4 b- defN 23-Jul-29 23:25 hat_drivers-0.7.5.dist-info/top_level.txt
+-rw-r--r--  2.0 unx        1 b- defN 23-Jul-29 23:25 hat_drivers-0.7.5.dist-info/zip-safe
+-rw-rw-r--  2.0 unx     9927 b- defN 23-Jul-29 23:25 hat_drivers-0.7.5.dist-info/RECORD
+110 files, 1261207 bytes uncompressed, 260008 bytes compressed:  79.4%
```

## zipnote {}

```diff
@@ -306,26 +306,26 @@
 
 Filename: hat/drivers/upnp/__init__.py
 Comment: 
 
 Filename: hat/drivers/upnp/description.py
 Comment: 
 
-Filename: hat_drivers-0.7.4.dist-info/LICENSE
+Filename: hat_drivers-0.7.5.dist-info/LICENSE
 Comment: 
 
-Filename: hat_drivers-0.7.4.dist-info/METADATA
+Filename: hat_drivers-0.7.5.dist-info/METADATA
 Comment: 
 
-Filename: hat_drivers-0.7.4.dist-info/WHEEL
+Filename: hat_drivers-0.7.5.dist-info/WHEEL
 Comment: 
 
-Filename: hat_drivers-0.7.4.dist-info/top_level.txt
+Filename: hat_drivers-0.7.5.dist-info/top_level.txt
 Comment: 
 
-Filename: hat_drivers-0.7.4.dist-info/zip-safe
+Filename: hat_drivers-0.7.5.dist-info/zip-safe
 Comment: 
 
-Filename: hat_drivers-0.7.4.dist-info/RECORD
+Filename: hat_drivers-0.7.5.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## hat/drivers/iec60870/link/endpoint.py

```diff
@@ -66,7 +66,11 @@
             except Exception as e:
                 mlog.error("error decoding message: %s", e, exc_info=e)
 
     async def send(self, msg: common.Frame):
         """Send"""
         data = self._encoder.encode(msg)
         await self._endpoint.write(data)
+
+    async def drain(self):
+        """Drain"""
+        await self._endpoint.drain()
```

## hat/drivers/iec60870/link/unbalanced/master.py

```diff
@@ -156,14 +156,15 @@
                     await asyncio.sleep(sleep_duration)
 
                 if not self._receive_queue.empty():
                     self._receive_queue.get_nowait_until_empty()
 
                 mlog.debug("writing request %s", req.function.name)
                 await self._endpoint.send(req)
+                await self._endpoint.drain()
 
                 if (req.address == self._broadcast_address or
                         req.function == common.ReqFunction.DATA_NO_RES):
                     last_read_time = time.monotonic()
                     if not future.done():
                         future.set_result(None)
                     continue
```

## hat/drivers/modbus/master.py

```diff
@@ -311,14 +311,15 @@
                     while not future or future.done():
                         req_adu, future = await self._send_queue.get()
 
                 await self._reset_input_buffer()
                 self._log(logging.DEBUG, "stopped discarding incomming data")
 
                 await self._conn.send(req_adu)
+                await self._conn.drain()
 
                 async with self.async_group.create_subgroup(
                         log_exceptions=False) as subgroup:
                     receive_task = subgroup.spawn(self._conn.receive,
                                                   self._modbus_type,
                                                   transport.Direction.RESPONSE)
```

## hat/drivers/modbus/transport/connection.py

```diff
@@ -48,14 +48,19 @@
 
         buff = memoryview(buff)
         adu, _ = encoder.decode_adu(modbus_type, direction, buff)
 
         self._log(logging.DEBUG, "received adu: %s", adu)
         return adu
 
+    async def drain(self):
+        self._log(logging.DEBUG, "draining output buffer")
+        await self._drain()
+        self._log(logging.DEBUG, "output buffer empty")
+
     async def reset_input_buffer(self) -> int:
         counter = 0
 
         while True:
             i = await self._reset_input_buffer()
             if not i:
                 break
@@ -139,14 +144,17 @@
 
     async def _write(self, data):
         await self._endpoint.write(data)
 
     async def _read(self, size):
         return await self._endpoint.read(size)
 
+    async def _drain(self):
+        await self._endpoint.drain()
+
     async def _reset_input_buffer(self):
         return await self._endpoint.reset_input_buffer()
 
 
 class _TcpConnection(Connection):
 
     def __init__(self, conn):
@@ -163,14 +171,16 @@
 
     @property
     def log_prefix(self):
         return self._log_prefix
 
     async def _write(self, data):
         await self._conn.write(data)
-        await self._conn.drain()
 
     async def _read(self, size):
         return await self._conn.readexactly(size)
 
+    async def _drain(self):
+        await self._conn.drain()
+
     async def _reset_input_buffer(self):
         return self._conn.reset_input_buffer()
```

## hat/drivers/serial/common.py

```diff
@@ -52,14 +52,23 @@
 
         Raises:
             ConnectionError
 
         """
 
     @abc.abstractmethod
+    async def drain(self):
+        """Drain output buffer
+
+        Raises:
+            ConnectionError
+
+        """
+
+    @abc.abstractmethod
     async def reset_input_buffer(self) -> int:
         """Reset input buffer
 
         Returns number of bytes available in buffer immediately before
         buffer was cleared.
 
         Raises:
```

## hat/drivers/serial/native_serial.py

```diff
@@ -1,17 +1,20 @@
 """Implementation based on native serial communication"""
 
 import asyncio
+import contextlib
+import functools
 import logging
 import sys
-import functools
 
 from hat import aio
+from hat import util
 
 from hat.drivers.serial import common
+
 from hat.drivers.serial import _native_serial
 
 
 if sys.platform == 'win32':
     raise ImportError('WIP')
 
 
@@ -24,28 +27,27 @@
                  bytesize=common.ByteSize.EIGHTBITS,
                  parity=common.Parity.NONE,
                  stopbits=common.StopBits.ONE,
                  xonxoff=False,
                  rtscts=False,
                  dsrdtr=False,
                  silent_interval=0):
-    loop = asyncio.get_running_loop()
-
     endpoint = Endpoint()
     endpoint._port = port
     endpoint._silent_interval = silent_interval
-    endpoint._input_buffer = bytearray()
+    endpoint._loop = asyncio.get_running_loop()
+    endpoint._input_buffer = util.BytesBuffer()
     endpoint._input_cv = asyncio.Condition()
     endpoint._write_queue = aio.Queue()
 
     endpoint._serial = _native_serial.Serial(in_buff_size=0xFFFF,
                                              out_buff_size=0xFFFF)
 
-    endpoint._close_cb_future = loop.create_future()
-    close_cb = _create_serial_cb(loop, endpoint._close_cb_future)
+    endpoint._close_cb_future = endpoint._loop.create_future()
+    close_cb = endpoint._create_serial_cb(endpoint._close_cb_future)
     endpoint._serial.set_close_cb(close_cb)
 
     endpoint._serial.open(
         port=port,
         baudrate=baudrate,
         bytesize=bytesize.value,
         parity=parity.value,
@@ -77,124 +79,144 @@
         return self._port
 
     async def read(self, size):
         async with self._input_cv:
             while len(self._input_buffer) < size:
                 if not self.is_open:
                     raise ConnectionError()
-                await self._input_cv.wait()
 
-            if size < 1:
-                return b''
+                await self._input_cv.wait()
 
-            buffer = memoryview(self._input_buffer)
-            data, self._input_buffer = buffer[:size], bytearray(buffer[size:])
-            return data
+            return self._input_buffer.read(size)
 
     async def write(self, data):
-        loop = asyncio.get_running_loop()
-        future = loop.create_future()
-
+        future = self._loop.create_future()
         try:
             self._write_queue.put_nowait((data, future))
             await future
 
         except aio.QueueClosedError:
             raise ConnectionError()
 
+    async def drain(self):
+        future = self._loop.create_future()
+        try:
+            self._write_queue.put_nowait((None, future))
+            await future
+
+        except aio.QueueClosedError:
+            raise ConnectionError()
+
     async def reset_input_buffer(self):
         async with self._input_cv:
-            count = len(self._input_buffer)
-            self._input_buffer = bytearray()
-            return count
+            return self._input_buffer.clear()
 
     async def _on_close(self):
         self._serial.close()
 
         await self._close_cb_future
 
         async with self._input_cv:
             self._input_cv.notify_all()
 
         self._serial.set_close_cb(None)
 
     async def _read_loop(self):
         try:
-            loop = asyncio.get_running_loop()
-
             while True:
-                in_change_cb_future = loop.create_future()
-                in_change_cb = _create_serial_cb(loop, in_change_cb_future)
-                self._serial.set_in_change_cb(in_change_cb)
+                with self._create_in_change_future() as change_future:
 
-                data = self._serial.read()
+                    data = self._serial.read()
 
-                if not data:
-                    await in_change_cb_future
-                    continue
-
-                self._serial.set_in_change_cb(None)
+                    if not data:
+                        await change_future
+                        continue
 
                 async with self._input_cv:
-                    self._input_buffer.extend(data)
+                    self._input_buffer.add(data)
                     self._input_cv.notify_all()
 
         except Exception as e:
             mlog.warning('read loop error: %s', e, exc_info=e)
 
         finally:
             self.close()
-            self._serial.set_in_change_cb(None)
 
     async def _write_loop(self):
         future = None
         try:
-            loop = asyncio.get_running_loop()
-
             while True:
                 data, future = await self._write_queue.get()
 
-                data = memoryview(data)
-                while data:
-                    out_empty_cb_future = loop.create_future()
-                    out_empty_cb = _create_serial_cb(loop, out_empty_cb_future)
-                    self._serial.set_out_empty_cb(out_empty_cb)
-
-                    result = self._serial.write(bytes(data))
-                    if result < 0:
-                        raise Exception('write error')
+                if data is None:
+                    with self._create_drain_future() as drain_future:
+                        self._serial.drain()
+
+                        await drain_future
+
+                else:
+                    data = memoryview(data)
+                    while data:
+                        with self._create_out_change_future() as change_future:
+                            result = self._serial.write(bytes(data))
+                            if result < 0:
+                                raise Exception('write error')
 
-                    data = data[result:]
+                            data = data[result:]
 
-                    await out_empty_cb_future
-
-                self._serial.set_out_empty_cb(None)
+                            if data:
+                                await change_future
 
                 if not future.done():
                     future.set_result(None)
 
                 await asyncio.sleep(self._silent_interval)
 
         except Exception as e:
             mlog.warning('write loop error: %s', e, exc_info=e)
 
         finally:
             self.close()
             self._write_queue.close()
-            self._serial.set_out_empty_cb(None)
 
             while True:
                 if future and not future.done():
                     future.set_exception(ConnectionError())
                 if self._write_queue.empty():
                     break
                 _, future = self._write_queue.get_nowait()
 
+    @contextlib.contextmanager
+    def _create_in_change_future(self):
+        with self._create_serial_future(self._serial.set_in_change_cb) as f:
+            yield f
+
+    @contextlib.contextmanager
+    def _create_out_change_future(self):
+        with self._create_serial_future(self._serial.set_out_change_cb) as f:
+            yield f
+
+    @contextlib.contextmanager
+    def _create_drain_future(self):
+        with self._create_serial_future(self._serial.set_drain_cb) as f:
+            yield f
+
+    @contextlib.contextmanager
+    def _create_serial_future(self, serial_set_cb):
+        future = self._loop.create_future()
+        cb = self._create_serial_cb(future)
+        serial_set_cb(cb)
+
+        try:
+            yield future
+
+        finally:
+            serial_set_cb(None)
 
-def _create_serial_cb(loop, future):
-    return functools.partial(loop.call_soon_threadsafe, _try_set_result,
-                             future, None)
+    def _create_serial_cb(self, future):
+        return functools.partial(self._loop.call_soon_threadsafe,
+                                 _try_set_result, future, None)
 
 
 def _try_set_result(future, result):
     if not future.done():
         future.set_result(result)
```

## hat/drivers/serial/py_serial.py

```diff
@@ -91,14 +91,23 @@
         try:
             self._write_queue.put_nowait((data, future))
             await future
 
         except aio.QueueClosedError:
             raise ConnectionError()
 
+    async def drain(self):
+        future = asyncio.Future()
+        try:
+            self._write_queue.put_nowait((None, future))
+            await future
+
+        except aio.QueueClosedError:
+            raise ConnectionError()
+
     async def reset_input_buffer(self):
         async with self._input_cv:
             count = len(self._input_buffer)
             self._input_buffer = bytearray()
             return count
 
     async def _on_close(self):
@@ -133,15 +142,19 @@
 
     async def _write_loop(self):
         future = None
         try:
             while True:
                 data, future = await self._write_queue.get()
 
-                await self._executor.spawn(self._ext_write, data)
+                if data is not None:
+                    await self._executor.spawn(self._ext_write, data)
+
+                else:
+                    await self._executor.spawn(self._ext_flush)
 
                 if not future.done():
                     future.set_result(None)
 
                 await asyncio.sleep(self._silent_interval)
 
         except Exception as e:
@@ -168,8 +181,10 @@
         if n < 1:
             return b''
 
         return self._serial.read(n)
 
     def _ext_write(self, data):
         self._serial.write(data)
+
+    def _ext_flush(self):
         self._serial.flush()
```

## Comparing `hat_drivers-0.7.4.dist-info/LICENSE` & `hat_drivers-0.7.5.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `hat_drivers-0.7.4.dist-info/METADATA` & `hat_drivers-0.7.5.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: hat-drivers
-Version: 0.7.4
+Version: 0.7.5
 Summary: Hat communication drivers
 Home-page: https://github.com/hat-open/hat-drivers
 License: Apache-2.0
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: Apache Software License
 Requires-Python: >=3.10
 Description-Content-Type: text/x-rst
```

## Comparing `hat_drivers-0.7.4.dist-info/RECORD` & `hat_drivers-0.7.5.dist-info/RECORD`

 * *Files 6% similar despite different names*

```diff
@@ -54,57 +54,57 @@
 hat/drivers/iec60870/encodings/iec104/encoder.py,sha256=G3JRIYqKtX2vs5tNFTlW6GdJY66IXpeQZrDI_m5ZyTI,9948
 hat/drivers/iec60870/encodings/security/__init__.py,sha256=izPfuQ8hgGaDOoOseUadpPjkFuj6DomdJ_ZqJnlfKeU,2227
 hat/drivers/iec60870/encodings/security/common.py,sha256=wWwHbswocYMTa9zBm0sHnmcsoBP8UfHT9zF7TiWHXsY,7298
 hat/drivers/iec60870/encodings/security/encoder.py,sha256=BR165hvumdoOLX4DvAwli5mlv0ifPZxdGlsV7eb8XQ0,25146
 hat/drivers/iec60870/link/__init__.py,sha256=jkaeqZMe7Roc04bPobbJHRm5LrO5J6QsSQe9fF14qsE,146
 hat/drivers/iec60870/link/common.py,sha256=nbyQ7rx-C_zOeVlYqPi1RcAg3i-PmQpMbGbm85I8Ws8,1309
 hat/drivers/iec60870/link/encoder.py,sha256=Uk5ElGpNdSatCVMYVYA4KwJ_gTXXwDkrSsOlgQ1TXBk,4838
-hat/drivers/iec60870/link/endpoint.py,sha256=e-5kEtZZsssj2jIOudy8sSTa4KgcLwXv7-RKHhc4xDs,1999
+hat/drivers/iec60870/link/endpoint.py,sha256=G6YkiLk2XooxwSW7_Pi7kxYgA_NMxH-NA58eClVOsqs,2084
 hat/drivers/iec60870/link/balanced/__init__.py,sha256=dbAnQ9uYvjkorbaThlLDoRXp58mV3PWhCLNZL-hq2_8,90
 hat/drivers/iec60870/link/balanced/connection.py,sha256=ou533ayiCZpxGv7zlnzl_9w9AmVGY5OaQ8EoeJVraJ8,1117
 hat/drivers/iec60870/link/unbalanced/__init__.py,sha256=gZoT9UcC4Fxoa77UiDz63CIeGDQNeV8SF-wX54cxtNM,771
-hat/drivers/iec60870/link/unbalanced/master.py,sha256=-3zSC7lqhBi3rqbJL8Kmvo1wsrVcMmJMn8jTATmsLb0,11724
+hat/drivers/iec60870/link/unbalanced/master.py,sha256=uej2nENA6szK0LrbcT45lflaX4p70fbhwZIqaTvOxQE,11769
 hat/drivers/iec60870/link/unbalanced/slave.py,sha256=UNAGHYCSVieH-8EyYpWpNEop5TJubuvOjzxTpfrsDV4,8459
 hat/drivers/mms/__init__.py,sha256=Z2QQ6YpGyMLLXZJr6Jsr2cI6OwQR6z8WO_QDcGKYtV8,4404
 hat/drivers/mms/asn1_repo.json,sha256=kgJs61OAUoruZ_8rTEQyKn4ZZoTNYiUS1t9h-vZZEuk,186717
 hat/drivers/mms/common.py,sha256=IC6SXfRD-IS7-KWGxXivwAv37XN6AmBnDZIHnU6weiU,8238
 hat/drivers/mms/connection.py,sha256=GqJsvqMQfpu7n47IznhCh2Bm6ropT_xZZa6lVYHA1FE,13117
 hat/drivers/mms/encoder.py,sha256=HXUFWeGNJx1KN2wMqPLCiCCW2fyMgtF6i8B1hY84ao0,26924
 hat/drivers/modbus/__init__.py,sha256=0QHorC_OjrIKfxZeEY1FU7RIOY1vl2jJCwbg09WcomM,1112
 hat/drivers/modbus/common.py,sha256=i7ZdYxQ4S9XAg0VF6MZ-__OK2-xwIjfQrFC5NGTVNOo,532
-hat/drivers/modbus/master.py,sha256=L9MhEdnwhw7x3zWShHfV1uaPrjelgS1SEK7fxE5bMFI,13153
+hat/drivers/modbus/master.py,sha256=49KyErkL8SYJwiqVSgc6S6BGd6emlQGSSD3TFwBqTig,13194
 hat/drivers/modbus/slave.py,sha256=CgNMR9z0MWbLFV4V2JXK4vYs-4DxmAMzE4Uv8fS88yo,16491
 hat/drivers/modbus/transport/__init__.py,sha256=BaavJsOVBa_ruNub5XSd1mlrSVHQBvj5kexEVj9D14s,3526
-hat/drivers/modbus/transport/_encoder.abi3.pyd,sha256=ZI0wADIWqaiA89MY1OEDhGflDAr1rm5-UUH9N9XRtFA,108045
+hat/drivers/modbus/transport/_encoder.abi3.pyd,sha256=kZ2j4JwdKWijNn2jgaVTP1ydGLsAcT416f8H_fQKsNo,108045
 hat/drivers/modbus/transport/common.py,sha256=kKPc3Xzat1NH4Y9dhkS7YOZ9xa0_k6fdbS53mPDOjFE,4552
-hat/drivers/modbus/transport/connection.py,sha256=jn-WhItQM93dfU4MM9LLJenK0HUdJFfQsMZ-UmwoniU,4709
+hat/drivers/modbus/transport/connection.py,sha256=yUgBU1EBiwGkyoZ-xEGfjmVobt3LLydu8KuXcgdm8sQ,4975
 hat/drivers/modbus/transport/encoder.py,sha256=-4agUbvdn24LUbC295BxnKN9sUYY2WsZKQ2WbSDSu_M,19933
 hat/drivers/pnetgateway/__init__.py,sha256=H6q9I-xn4rf0Z0YUoVgJgLao8ihOGaQPFWYo0YIGhmA,823
 hat/drivers/pnetgateway/client.py,sha256=e4nbw53PpEnvNOOIl_p9jKeZ5-WXVM5i1nbSlM4F27c,6296
 hat/drivers/pnetgateway/common.py,sha256=XL73Ym1zABJckyIDtQy2TNj9170Y3dhaZdGQmqaoQcQ,1142
 hat/drivers/pnetgateway/encoder.py,sha256=rwey5rL4k8je30h0OoeorDFzqf_AgKSS_tP6k6BG8HQ,1881
 hat/drivers/pnetgateway/transport.py,sha256=2DdWFEtDPPq3HA9r1zO4DnodJh1opMZbkRH-GLECpS0,803
 hat/drivers/serial/__init__.py,sha256=A41ydYvdskql49bpUDKjx-aPBA2tuJaRWwf7PaFK39s,1965
-hat/drivers/serial/_native_serial.abi3.pyd,sha256=RsY1xGLXV2qD8l_IjmozgLZsIE8N1ZvdBkyyyxqPxpw,120682
-hat/drivers/serial/common.py,sha256=y-h9G2fhrAMk4y8mxntJ_JLA3lRFhWeXqXl9BQtR_WY,1103
-hat/drivers/serial/native_serial.py,sha256=DkrapIqZOjTATLuyBDrWARvQfbV9g3QhcuIB7y8ZXlA,5794
-hat/drivers/serial/py_serial.py,sha256=DashtcNGeIcadeS1waUfJjxzON19clDFyqXYXGfz_pg,4681
+hat/drivers/serial/_native_serial.abi3.pyd,sha256=4HBmv8lrQQFnJwMKnwOXSzHpb2GEBPCqaAZXtskD_tI,120822
+hat/drivers/serial/common.py,sha256=y8aR7jBgiM0ZbxzBOliSI1csXNIWcW9crv_5HrQ8prY,1244
+hat/drivers/serial/native_serial.py,sha256=FRGyVOgECnMiuPk26Zuix0inV3emjVbOsTjJ8Ht3AyM,6403
+hat/drivers/serial/py_serial.py,sha256=MB9Sof54vJziSbuBqpyK_re_olQs1IAyxsQ7PyVU2zY,5067
 hat/drivers/snmp/__init__.py,sha256=PaxY_z6W9f-hDZBB4YfuhJm6RzHgc2hJzEbe2pdxv2c,1879
 hat/drivers/snmp/agent.py,sha256=BczItjPQAR8u77I-19PYf43IWDBUL7jGSwYcB8fd6cU,6185
 hat/drivers/snmp/common.py,sha256=4ocgyPjjTQQMFhJQjwMnq6EWpmE5aIdNd_fr3vlJnY8,4871
 hat/drivers/snmp/manager.py,sha256=n1BRNp9WRdP948rUoxctfEuDlnW6CBmaPN1OtbsjDPw,7546
 hat/drivers/snmp/trap.py,sha256=Y7UlDoAeV0lNaOhzHZwEvKUIwMBZjHgcrA17CJ4m8VA,12554
 hat/drivers/snmp/encoder/__init__.py,sha256=vWsrue7-LVP1FCEY4-V9bWrkJ__Z84OO04oUB0oZ37Y,2598
 hat/drivers/snmp/encoder/asn1_repo.json,sha256=pW-zNotno2j-q-RPNtike2yzyMMPL3S9Ls-ctSFglMc,9211
 hat/drivers/snmp/encoder/v1.py,sha256=1qSWdX4W4Z0Qe9QxXfT7LnM87O5iwpu3gOEKJIJtvyI,6241
 hat/drivers/snmp/encoder/v2c.py,sha256=HJMTeZu-hSdp1Ti5OKJPCwNx6DEAzO402jMW9PBadIM,7935
 hat/drivers/snmp/encoder/v3.py,sha256=bY5yBFvw-SdoaIo_5hr0e_7vUvHhPrSZen9eF9CqHlY,1943
 hat/drivers/ssl/__init__.py,sha256=91IGwrFBWEkq_NjbqF7PNQhXQSFZSIf64FKjSFygW4w,2082
-hat/drivers/ssl/_ssl.abi3.pyd,sha256=OlR1gF92lSieZrb8wpeUbhbWCJEdUJC-sdJ-MKBNbyE,107412
+hat/drivers/ssl/_ssl.abi3.pyd,sha256=X8UHFEB-vvagZ20w_LKqLLDYKQWL8wHGz774ui1B88U,107412
 hat/drivers/upnp/__init__.py,sha256=DmKhdhUxEVXPtrJ1IY4xavSZvAimJJVP86ikJrMJ8Wk,34
 hat/drivers/upnp/description.py,sha256=xcBhslCKk6p50QYw7TfvRMrjrOPTj2FYqS_yuvdT2ww,3132
-hat_drivers-0.7.4.dist-info/LICENSE,sha256=z8d0m5b2O9McPEK1xHG_dWgUBT6EfBDz6wA0F7xSPTA,11358
-hat_drivers-0.7.4.dist-info/METADATA,sha256=obmz4V53SF5xp-wCtn7EWuSN7aoJXN6_faSAwggcEjI,2484
-hat_drivers-0.7.4.dist-info/WHEEL,sha256=EIDplvKX77HSdIuX_rx4QpXXtuIW5PK_-oQMxkWTHag,127
-hat_drivers-0.7.4.dist-info/top_level.txt,sha256=3RuRoRsaXQZNKwr3T2RE9XepBRTk4YpnXUbMiH5nes8,4
-hat_drivers-0.7.4.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
-hat_drivers-0.7.4.dist-info/RECORD,,
+hat_drivers-0.7.5.dist-info/LICENSE,sha256=z8d0m5b2O9McPEK1xHG_dWgUBT6EfBDz6wA0F7xSPTA,11358
+hat_drivers-0.7.5.dist-info/METADATA,sha256=3Pys243cbP3Twnklnv6yk8qK7G2LNN1IdiD30SWOB24,2484
+hat_drivers-0.7.5.dist-info/WHEEL,sha256=EIDplvKX77HSdIuX_rx4QpXXtuIW5PK_-oQMxkWTHag,127
+hat_drivers-0.7.5.dist-info/top_level.txt,sha256=3RuRoRsaXQZNKwr3T2RE9XepBRTk4YpnXUbMiH5nes8,4
+hat_drivers-0.7.5.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
+hat_drivers-0.7.5.dist-info/RECORD,,
```

